name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  pre-deploy-checks:
    name: Pre-Deploy Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Build TypeScript
        run: npm run build

      - name: Check build artifacts
        run: |
          if [ ! -d "dist" ]; then
            echo "Build failed: dist directory not found"
            exit 1
          fi
          echo "‚úÖ Build successful"

      - name: Check migration files
        run: |
          echo "üîç Checking migration files..."
          if [ ! -d "prisma/migrations" ]; then
            echo "‚ùå No migrations directory found"
            exit 1
          fi
          if [ -z "$(ls -A prisma/migrations)" ]; then
            echo "‚ö†Ô∏è  Migration directory is empty"
          else
            echo "‚úÖ Migration files found"
            ls -la prisma/migrations/
          fi

      - name: Validate Prisma schema
        run: |
          echo "üîç Validating Prisma schema..."
          npx prisma validate || {
            echo "‚ùå Prisma schema validation failed"
            exit 1
          }
          echo "‚úÖ Prisma schema is valid"

  migration-check:
    name: Migration Validation
    runs-on: ubuntu-latest
    needs: pre-deploy-checks

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Setup test database
        run: |
          echo "üîß Setting up test database..."
          export DATABASE_URL="postgresql://postgres:postgres@localhost:5432/test_db?schema=public"

          # Apply migrations to test database
          if [ -d "prisma/migrations" ] && [ "$(ls -A prisma/migrations)" ]; then
            echo "üîÑ Applying migrations to test database..."
            npx prisma migrate deploy || {
              echo "‚ùå Migration deployment failed on test database"
              exit 1
            }
            echo "‚úÖ Migrations applied successfully"
          else
            echo "‚ö†Ô∏è  No migrations to apply"
          fi

          # Validate database schema
          echo "üîç Validating database schema..."
          npx prisma db push --accept-data-loss || {
            echo "‚ùå Database schema validation failed"
            exit 1
          }
          echo "‚úÖ Database schema is valid"

  deploy:
    name: Deploy to VDS
    needs: migration-check
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}
            echo "üì• Fetching latest changes..."
            git fetch origin
            echo "üîÑ Resetting to origin/main..."
            git reset --hard origin/main
            echo "üöÄ Starting deployment..."
            ./deploy.sh
            echo "‚úÖ Deployment completed!"
      
      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}
            echo "üìä Container status:"
            docker compose -f docker-compose.prod.yml ps
            echo ""
            echo "üîç Checking bot status..."
            if docker compose -f docker-compose.prod.yml ps | grep -q "Up"; then
              echo "‚úÖ Bot is running"
              echo "üìù Current commit: $(git log --oneline -1)"
            else
              echo "‚ùå Bot is not running"
              echo "üìã Recent logs:"
              docker compose -f docker-compose.prod.yml logs --tail=50 bot
              exit 1
            fi
            echo ""
            echo "üóÑÔ∏è  Checking migration status..."
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–π
            MIGRATION_STATUS=$(docker compose -f docker-compose.prod.yml exec -T bot ./scripts/migration-health.sh 2>/dev/null || echo "MIGRATION_CHECK_FAILED")
            if [[ "$MIGRATION_STATUS" == *"completed successfully"* ]]; then
              echo "‚úÖ Database migrations are up to date"
            else
              echo "‚ö†Ô∏è  Migration status check failed or migrations needed"
              echo "Status: $MIGRATION_STATUS"
              echo "üìã Migration logs:"
              docker compose -f docker-compose.prod.yml logs --tail=20 bot | grep -i migration || echo "No migration logs found"
            fi
