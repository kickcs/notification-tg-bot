## Context
Добавление квиз-викторины в Telegram бота требует управления временными сессиями, хранения вопросов в базе данных и обработки интерактивных ответов через inline-кнопки.

## Goals / Non-Goals
**Goals:**
- Предоставить администратору возможность создавать и управлять вопросами квиза
- Позволить пользователям запускать квиз с настраиваемым количеством вопросов
- Обеспечить интерактивный опыт с немедленной обратной связью после каждого ответа
- Показывать финальную статистику прохождения

**Non-Goals:**
- Сохранение истории прохождения квизов в базе данных
- Рейтинговая система или таблица лидеров
- Мультиплеерный режим или соревнования между пользователями
- Таймеры или ограничения по времени на ответы

## Decisions

### 1. Хранение квизов и вопросов в базе данных
**Решение:** Использовать три связанные таблицы `Quiz`, `QuizQuestion` и `QuizOption`

**Обоснование:**
- Гибкость: администратор может создавать несколько независимых квизов
- Организация: вопросы группируются по квизам (например, "Медицина", "История", "География")
- Масштабируемость: легко расширить количество квизов и вопросов
- Структурированность: четкая иерархия Quiz → Questions → Options

**Структура:**
- `Quiz`: id, name (unique), description, isActive
- `QuizQuestion`: id, quizId (FK), questionText
- `QuizOption`: id, questionId (FK), optionText, isCorrect

**Альтернативы:**
- Хранение в JSON-файле: менее гибко, требует перезапуска бота
- Хардкод в коде: невозможно изменять без деплоя
- Одна общая база вопросов: сложнее организовать тематические квизы

### 2. Управление сессиями квиза
**Решение:** In-memory хранилище (Map) для активных сессий

**Обоснование:**
- Простота: не требует дополнительных таблиц в БД
- Производительность: быстрый доступ к данным сессии
- Временность: сессии не нужно сохранять после завершения
- Соответствует требованию: не сохранять историю прохождения

**Структура сессии:**
```typescript
interface QuizSession {
  userId: bigint;
  chatId: bigint;
  quizName: string;
  questions: Array<{
    id: string;
    questionText: string;
    options: Array<{ id: string; text: string; isCorrect: boolean }>;
  }>;
  currentIndex: number;
  correctCount: number;
  incorrectCount: number;
}
```

**Ключ сессии:** `${userId}_${chatId}` для поддержки одного активного квиза на пользователя в чате

**Альтернативы:**
- Хранение в БД: избыточно для временных данных, увеличивает нагрузку
- Redis: излишняя сложность для текущего масштаба

### 3. Формат команды добавления вопроса
**Решение:** Многошаговый диалог через состояния

**Обоснование:**
- UX: проще для администратора, чем длинная команда с разделителями
- Валидация: можно проверять каждый шаг отдельно
- Гибкость: легко добавить дополнительные поля в будущем

**Процесс:**
1. `/addquestion` - начало диалога
2. Бот запрашивает текст вопроса
3. Бот запрашивает варианты ответов (по одному)
4. Бот запрашивает номер правильного ответа
5. Сохранение в БД

**Альтернативы:**
- Одна команда с разделителями: `/addquestion Вопрос? | Вариант1 | Вариант2 | Вариант3 | 2`
  - Минусы: сложно для пользователя, проблемы с экранированием

### 4. Использование inline-кнопок для ответов
**Решение:** Inline keyboard с callback_data

**Обоснование:**
- Интерактивность: пользователь просто нажимает кнопку
- UX: визуально понятно, что это варианты ответа
- Telegram API: нативная поддержка, не требует парсинга текста

**Формат callback_data:** `quiz_answer:{sessionKey}:{optionId}`

### 5. Загрузка вопросов квиза
**Решение:** Загружать все вопросы квиза и перемешивать их в памяти

**Обоснование:**
- Простота: использовать стандартный Prisma запрос + shuffle в JS
- Гибкость: пользователь проходит все вопросы квиза
- Предсказуемость: количество вопросов определяется содержимым квиза

**Альтернативы:**
- SQL `ORDER BY RANDOM()`: работает, но менее предсказуемо
- Фиксированное количество: ограничивает гибкость квизов разной длины

## Risks / Trade-offs

### Risk 1: Потеря сессий при перезапуске бота
**Митигация:** Добавить graceful shutdown с уведомлением активных пользователей

### Risk 2: Одновременные квизы в одном чате
**Митигация:** Использовать составной ключ `${userId}_${chatId}` для сессий

### Risk 3: Недостаточно вопросов в базе
**Митигация:** Валидация при запуске квиза, информативное сообщение об ошибке

### Risk 4: Администратор создает вопрос без правильного ответа
**Митигация:** Обязательная валидация при создании вопроса

## Migration Plan
1. Создать миграцию для новых таблиц
2. Применить миграцию на production БД
3. Деплой нового кода с командами квиза
4. Администратор добавляет начальный набор вопросов через `/addquestion`

**Rollback:**
- Откат кода к предыдущей версии
- Таблицы можно оставить (не влияют на работу старого кода)

## Open Questions
- Нужно ли ограничение на максимальное количество вопросов в одном квизе? (предлагаю 50)
- Сколько вариантов ответов должно быть у каждого вопроса? (предлагаю 4)
- Нужно ли ограничение на одновременный квиз для одного пользователя? (да, один квиз на пользователя в чате)
- Можно ли запускать один и тот же квиз повторно? (да, вопросы будут в случайном порядке)
