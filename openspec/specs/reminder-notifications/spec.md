# reminder-notifications Specification

## Purpose
TBD - created by archiving change add-medication-reminder-system. Update Purpose after archive.
## Requirements
### Requirement: Автоматическая отправка напоминаний по расписанию
Система MUST автоматически отправлять напоминания о приеме таблеток согласно настроенному расписанию.

#### Scenario: Отправка напоминания в заданное время
- **WHEN** наступает время из расписания пользователя (например, 09:00)
- **THEN** система создает запись Reminder в базе данных
- **AND** отправляет сообщение-напоминание в группу
- **AND** сообщение содержит inline-кнопку "Подтвердить"
- **AND** сообщение использует шаблон из базы данных
- **AND** сообщение содержит метку времени фактической отправки в формате `HH:MM`

#### Scenario: Множественные напоминания в день
- **WHEN** у пользователя настроено несколько времен (09:00, 14:00, 21:00)
- **THEN** система отправляет отдельное напоминание для каждого времени
- **AND** каждое напоминание независимо от других
- **AND** каждое сообщение содержит собственную метку времени отправки

#### Scenario: Отправка в правильную группу
- **WHEN** наступает время напоминания
- **THEN** система использует chatId из расписания
- **AND** отправляет сообщение именно в ту группу, где было создано расписание

### Requirement: Inline-кнопка подтверждения
Система MUST добавлять интерактивную кнопку для подтверждения приема таблеток.

#### Scenario: Кнопка с уникальным идентификатором
- **WHEN** отправляется напоминание
- **THEN** сообщение содержит inline-кнопку с текстом "Подтвердить"
- **AND** кнопка имеет callback_data формата "confirm_reminder:{reminderId}"
- **AND** reminderId уникально идентифицирует это напоминание

#### Scenario: Обработка нажатия кнопки
- **WHEN** пользователь нажимает кнопку "Подтвердить"
- **THEN** система создает запись Confirmation в базе данных
- **AND** обновляет статус Reminder на confirmed
- **AND** отменяет повторные напоминания для этого reminder
- **AND** отправляет сообщение-награду

### Requirement: Повторные напоминания при отсутствии подтверждения
Система MUST отправлять повторные напоминания если пользователь не подтвердил прием и удалять предыдущие сообщения-напоминания.

#### Scenario: Первое повторное напоминание
- **WHEN** прошло 15 минут после отправки напоминания
- **AND** пользователь не подтвердил прием
- **THEN** система удаляет предыдущее сообщение-напоминание
- **AND** отправляет новое повторное напоминание
- **AND** увеличивает счетчик попыток на 1
- **AND** сохраняет messageId нового сообщения
- **AND** сохраняет timestamp повторной отправки

#### Scenario: Максимум повторных попыток
- **WHEN** система отправила 3 повторных напоминания
- **AND** пользователь так и не подтвердил
- **THEN** система прекращает отправку повторных напоминаний
- **AND** помечает reminder как missed
- **AND** сохраняет информацию о пропуске

#### Scenario: Отмена повторных напоминаний после подтверждения
- **WHEN** пользователь подтверждает прием после первого напоминания
- **THEN** система отменяет все запланированные повторные напоминания
- **AND** не отправляет дополнительные сообщения

#### Scenario: Обработка ошибки удаления сообщения
- **WHEN** система пытается удалить предыдущее сообщение
- **AND** сообщение уже удалено пользователем или недоступно
- **THEN** система логирует предупреждение
- **AND** продолжает отправку нового напоминания
- **AND** не прерывает процесс из-за ошибки удаления

### Requirement: Использование шаблонов сообщений
Система MUST использовать шаблоны из базы данных для текста напоминаний.

#### Scenario: Выбор случайного шаблона
- **WHEN** система отправляет напоминание
- **THEN** выбирает случайный шаблон типа "reminder" из базы данных
- **AND** использует текст шаблона в сообщении
- **AND** обеспечивает разнообразие сообщений

#### Scenario: Fallback при отсутствии шаблонов
- **WHEN** в базе данных нет шаблонов типа "reminder"
- **THEN** система использует дефолтное сообщение
- **AND** логирует предупреждение об отсутствии шаблонов

### Requirement: Отправка сообщения-награды
Система MUST отправлять мотивационное сообщение после подтверждения приема таблеток.

#### Scenario: Награда после подтверждения
- **WHEN** пользователь подтверждает прием таблеток
- **THEN** система выбирает случайный шаблон типа "reward"
- **AND** отправляет сообщение-награду в ответ на подтверждение
- **AND** сообщение содержит позитивную мотивацию

#### Scenario: Награда в том же чате
- **WHEN** отправляется сообщение-награда
- **THEN** оно отправляется в тот же чат, где было напоминание
- **AND** является ответом (reply) на сообщение с подтверждением

### Requirement: Отслеживание статуса напоминаний
Система MUST сохранять статус каждого отправленного напоминания.

#### Scenario: Статусы напоминания
- **WHEN** создается напоминание
- **THEN** начальный статус "pending"
- **WHEN** пользователь подтверждает
- **THEN** статус меняется на "confirmed"
- **WHEN** достигнут лимит повторов без подтверждения
- **THEN** статус меняется на "missed"

#### Scenario: История напоминаний
- **WHEN** пользователь запрашивает историю
- **THEN** система показывает все напоминания с их статусами
- **AND** отображает дату и время каждого напоминания
- **AND** показывает было ли подтверждение

### Requirement: Сохранение идентификатора сообщения
Система MUST сохранять messageId отправленных напоминаний для возможности их последующего удаления.

#### Scenario: Сохранение messageId при первой отправке
- **WHEN** система отправляет первое напоминание
- **THEN** сохраняет messageId в базе данных
- **AND** связывает его с записью Reminder

#### Scenario: Обновление messageId при повторной отправке
- **WHEN** система отправляет повторное напоминание
- **THEN** обновляет messageId в базе данных
- **AND** заменяет старый messageId новым

