# CI/CD –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –î–µ–ø–ª–æ–π

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π –Ω–∞ production —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ GitHub Actions –ø—Ä–∏ –∫–∞–∂–¥–æ–º push –≤ –≤–µ—Ç–∫—É `main`.

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **Push –≤ main** ‚Üí GitHub Actions –∑–∞–ø—É—Å–∫–∞–µ—Ç workflow
2. **Pre-Deploy Checks** ‚Üí Build, Prisma generate, –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
3. **Deploy** ‚Üí SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ VDS, git pull, –∑–∞–ø—É—Å–∫ deploy.sh
4. **Verify** ‚Üí –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –±–æ—Ç –∑–∞–ø—É—â–µ–Ω

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ GitHub Secrets

–î–ª—è —Ä–∞–±–æ—Ç—ã CI/CD –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ secrets –≤ GitHub:

### 1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ Settings ‚Üí Secrets and variables ‚Üí Actions

### 2. –î–æ–±–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ secrets:

**SSH_PRIVATE_KEY**
```
–ü—Ä–∏–≤–∞—Ç–Ω—ã–π SSH –∫–ª—é—á –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ VDS.
–ü–æ–ª—É—á–∏—Ç—å: cat /tmp/ci-cd-key
```

**SSH_HOST**
```
188.225.38.67
```

**SSH_USER**
```
root
```

**DEPLOY_PATH**
```
/opt/notification-tg-bot
```

## –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—é secrets

### –®–∞–≥ 1: –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á

–ù–∞ –≤–∞—à–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ:

```bash
cat /tmp/ci-cd-key
```

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–µ—Å—å –≤—ã–≤–æ–¥ (–≤–∫–ª—é—á–∞—è `-----BEGIN OPENSSH PRIVATE KEY-----` –∏ `-----END OPENSSH PRIVATE KEY-----`).

### –®–∞–≥ 2: –î–æ–±–∞–≤–∏—Ç—å –≤ GitHub

1. –û—Ç–∫—Ä–æ–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–∞ GitHub
2. Settings ‚Üí Secrets and variables ‚Üí Actions
3. New repository secret
4. Name: `SSH_PRIVATE_KEY`
5. Value: –≤—Å—Ç–∞–≤—å—Ç–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª—é—á
6. Add secret

–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö secrets:
- `SSH_HOST`: `188.225.38.67`
- `SSH_USER`: `root`
- `DEPLOY_PATH`: `/opt/notification-tg-bot`

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π

–ü—Ä–æ—Å—Ç–æ —Å–¥–µ–ª–∞–π—Ç–µ push –≤ –≤–µ—Ç–∫—É `main`:

```bash
git add .
git commit -m "feat: –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è"
git push origin main
```

GitHub Actions –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç –¥–µ–ø–ª–æ–π.

### –†—É—á–Ω–æ–π –¥–µ–ø–ª–æ–π

–ú–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å workflow –≤—Ä—É—á–Ω—É—é:

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ Actions ‚Üí Deploy to Production
2. Run workflow ‚Üí Run workflow

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –¥–µ–ø–ª–æ—è

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ Actions
2. –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–∏–π workflow run
3. –û—Ç–∫—Ä–æ–π—Ç–µ job "Deploy to VDS"
4. –ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ –∫–∞–∂–¥–æ–≥–æ step

## –°—Ç–∞—Ç—É—Å—ã –¥–µ–ø–ª–æ—è

- ‚úÖ **Success** - –¥–µ–ø–ª–æ–π –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ
- ‚ùå **Failed** - –¥–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π
- üü° **In Progress** - –¥–µ–ø–ª–æ–π –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è

–°—Ç–∞—Ç—É—Å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è:
- –í –∫–æ–º–º–∏—Ç–µ (–∑–µ–ª–µ–Ω–∞—è –≥–∞–ª–æ—á–∫–∞ –∏–ª–∏ –∫—Ä–∞—Å–Ω—ã–π –∫—Ä–µ—Å—Ç–∏–∫)
- –í GitHub Actions
- –í README (badge, –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)

## Rollback

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π rollback (—á–µ—Ä–µ–∑ git revert)

```bash
# –ù–∞–π–¥–∏—Ç–µ –∫–æ–º–º–∏—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å
git log --oneline

# –û—Ç–∫–∞—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
git revert <commit-hash>

# –ó–∞–ø—É—à—å—Ç–µ
git push origin main
```

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –Ω–æ–≤—ã–π –¥–µ–ø–ª–æ–π —Å –æ—Ç–∫–∞—Ç–æ–º.

### –†—É—á–Ω–æ–π rollback (–±—ã—Å—Ç—Ä—ã–π)

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É
ssh root@188.225.38.67

# –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd /opt/notification-tg-bot

# –û—Ç–∫–∞—Ç–∏—Ç–µ –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –∫–æ–º–º–∏—Ç—É
git log --oneline  # –Ω–∞–π–¥–∏—Ç–µ –Ω—É–∂–Ω—ã–π –∫–æ–º–º–∏—Ç
git reset --hard <commit-hash>

# –ó–∞–¥–µ–ø–ª–æ–π—Ç–µ
./deploy.sh
```

## Pre-Deploy Checks

–ü–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

1. **npm ci** - —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
2. **npx prisma generate** - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è Prisma Client
3. **npm run build** - –∫–æ–º–ø–∏–ª—è—Ü–∏—è TypeScript
4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ dist/** - –Ω–∞–ª–∏—á–∏–µ —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

–ï—Å–ª–∏ –ª—é–±–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –ø—Ä–æ—à–ª–∞ - –¥–µ–ø–ª–æ–π –Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è.

## Branch Protection

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å branch protection –¥–ª—è `main`:

1. Settings ‚Üí Branches ‚Üí Add rule
2. Branch name pattern: `main`
3. –í–∫–ª—é—á–∏—Ç–µ:
   - ‚úÖ Require status checks to pass before merging
   - ‚úÖ Require branches to be up to date before merging
   - –í—ã–±–µ—Ä–∏—Ç–µ: `Pre-Deploy Checks`
4. Save changes

–¢–µ–ø–µ—Ä—å merge –≤ main –≤–æ–∑–º–æ–∂–µ–Ω —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫.

## Troubleshooting

### –û—à–∏–±–∫–∞: "Permission denied (publickey)"

**–ü—Ä–æ–±–ª–µ–º–∞**: SSH –∫–ª—é—á –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π.

**–†–µ—à–µ–Ω–∏–µ**:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `SSH_PRIVATE_KEY` –¥–æ–±–∞–≤–ª–µ–Ω –≤ GitHub Secrets
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:
   ```bash
   ssh root@188.225.38.67 "cat ~/.ssh/authorized_keys | grep ci-cd"
   ```

### –û—à–∏–±–∫–∞: "Build failed"

**–ü—Ä–æ–±–ª–µ–º–∞**: –ö–æ–¥ –Ω–µ –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è.

**–†–µ—à–µ–Ω–∏–µ**:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ GitHub Actions
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ build –ª–æ–∫–∞–ª—å–Ω–æ: `npm run build`
3. –ò—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –∏ –∑–∞–ø—É—à—å—Ç–µ —Å–Ω–æ–≤–∞

### –û—à–∏–±–∫–∞: "Bot is not running"

**–ü—Ä–æ–±–ª–µ–º–∞**: –ë–æ—Ç –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è.

**–†–µ—à–µ–Ω–∏–µ**:
1. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É: `ssh root@188.225.38.67`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `cd /opt/notification-tg-bot && ./logs.sh bot`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å: `docker compose -f docker-compose.prod.yml ps`
4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ: `docker compose -f docker-compose.prod.yml restart bot`

### Workflow –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

**–ü—Ä–æ–±–ª–µ–º–∞**: Push –≤ main –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç workflow.

**–†–µ—à–µ–Ω–∏–µ**:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ñ–∞–π–ª `.github/workflows/deploy.yml` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—ã –ø—É—à–∏—Ç–µ –≤ –≤–µ—Ç–∫—É `main` (–Ω–µ `master`)
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Actions ‚Üí All workflows ‚Üí Deploy to Production

### –î–µ–ø–ª–æ–π –∑–∞–≤–∏—Å–∞–µ—Ç

**–ü—Ä–æ–±–ª–µ–º–∞**: Workflow –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ.

**–†–µ—à–µ–Ω–∏–µ**:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ GitHub Actions
2. –í–æ–∑–º–æ–∂–Ω–æ, —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ SSH –¥–æ—Å—Ç—É–ø
3. –û—Ç–º–µ–Ω–∏—Ç–µ workflow –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –∑–∞–Ω–æ–≤–æ

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É
ssh root@188.225.38.67

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
cd /opt/notification-tg-bot
docker compose -f docker-compose.prod.yml ps

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
./logs.sh bot
```

### Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

GitHub –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç email –ø—Ä–∏:
- ‚ùå Failed workflow
- ‚úÖ Fixed workflow (–ø–æ—Å–ª–µ failed)

–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –≤ Settings ‚Üí Notifications.

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### SSH –∫–ª—é—á

- ‚úÖ –ö–ª—é—á —Å–æ–∑–¥–∞–Ω —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è CI/CD
- ‚úÖ –ö–ª—é—á —Ö—Ä–∞–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ GitHub Secrets (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω)
- ‚úÖ –ö–ª—é—á –Ω–µ –∏–º–µ–µ—Ç passphrase (–¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏)
- ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –ø—Ä–∞–≤–∞ –∫–ª—é—á–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

### –†–æ—Ç–∞—Ü–∏—è –∫–ª—é—á–µ–π

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –º–µ–Ω—è—Ç—å SSH –∫–ª—é—á –∫–∞–∂–¥—ã–µ 3 –º–µ—Å—è—Ü–∞:

```bash
# –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –∫–ª—é—á
ssh-keygen -t ed25519 -C "ci-cd@notification-bot" -f /tmp/ci-cd-key-new -N ""

# –î–æ–±–∞–≤—å—Ç–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
ssh root@188.225.38.67 "echo '$(cat /tmp/ci-cd-key-new.pub)' >> ~/.ssh/authorized_keys"

# –û–±–Ω–æ–≤–∏—Ç–µ –≤ GitHub Secrets
# Settings ‚Üí Secrets ‚Üí SSH_PRIVATE_KEY ‚Üí Update

# –£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä—ã–π –∫–ª—é—á —Å —Å–µ—Ä–≤–µ—Ä–∞
ssh root@188.225.38.67 "sed -i '/ci-cd@notification-bot/d' ~/.ssh/authorized_keys"
ssh root@188.225.38.67 "echo '$(cat /tmp/ci-cd-key-new.pub)' >> ~/.ssh/authorized_keys"
```

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –†—É—á–Ω–æ–π –¥–µ–ø–ª–æ–π

–ï—Å–ª–∏ CI/CD –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –≤—Å–µ–≥–¥–∞ –º–æ–∂–Ω–æ –∑–∞–¥–µ–ø–ª–æ–∏—Ç—å –≤—Ä—É—á–Ω—É—é:

```bash
ssh root@188.225.38.67
cd /opt/notification-tg-bot
git pull origin main
./deploy.sh
```

## –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [SSH Action](https://github.com/appleboy/ssh-action)
- [Branch Protection Rules](https://docs.github.com/en/repositories/configuring-branches-and-merges-in-your-repository/managing-protected-branches/about-protected-branches)
