import {type Conversation} from '@grammyjs/conversations';
import {createQuiz} from '../services/quizService';
import {MyContext} from '../types/context';

export async function createQuizConversation(conversation: Conversation<MyContext, MyContext>, ctx: MyContext) {
  await ctx.reply('üìù –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–≤–∏–∑–∞\n\n–î–ª—è –æ—Ç–º–µ–Ω—ã –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /cancel');

  const nameCtx = await conversation.waitFor('message:text');
  if (nameCtx.message?.text === '/cancel') {
    await ctx.reply('‚ùå –°–æ–∑–¥–∞–Ω–∏–µ –∫–≤–∏–∑–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ');
    return;
  }

  const name = nameCtx.message?.text;
  if (!name) {
    await ctx.reply('‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –ø–æ–ª—É—á–µ–Ω–æ');
    return;
  }

  await ctx.reply('üìù –í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–≤–∏–∑–∞ (–∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ "-" —á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å)');

  const descCtx = await conversation.waitFor('message:text');
  
  if (descCtx.message?.text === '/cancel') {
    await ctx.reply('‚ùå –°–æ–∑–¥–∞–Ω–∏–µ –∫–≤–∏–∑–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ');
    return;
  }

  const description = descCtx.message?.text;
  const finalDescription = description === '-' ? undefined : description;

  try {
    const quiz = await createQuiz(name, finalDescription);
    await ctx.reply(
      `‚úÖ –ö–≤–∏–∑ '${quiz.name}' —Å–æ–∑–¥–∞–Ω!\n\n` +
      `–î–æ–±–∞–≤—å—Ç–µ –≤–æ–ø—Ä–æ—Å—ã —Å –ø–æ–º–æ—â—å—é /addquestion ${quiz.name}`
    );
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–≤–∏–∑–∞:', error);
    const errorMessage = error instanceof Error ? error.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
    await ctx.reply(`‚ùå ${errorMessage}`);
  }
}
